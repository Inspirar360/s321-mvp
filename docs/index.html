<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema 3-2-1</title>

  <!-- Manifest versionado y color -->
  <link rel="manifest" href="manifest.json?v=7" />
  <meta name="theme-color" content="#0f172a" />

  <!-- iOS (opcional: agreg√° pwa-icons/apple-180.png si lo ten√©s) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="3-2-1" />
  <!-- <link rel="apple-touch-icon" sizes="180x180" href="pwa-icons/apple-180.png" /> -->

  <style>
    :root{
      --bg:#f8fafc; --fg:#0f172a; --muted:#64748b; --card:#fff; --b:#e2e8f0; --pri:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:640px;margin:0 auto;padding:16px}
    h1{font-size:28px;margin:12px 0 4px}
    p.muted{color:var(--muted);font-size:14px;margin:0 0 16px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 4px 16px rgba(0,0,0,.06);margin:12px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--b);background:#fff;font-size:16px}
    textarea{resize:vertical;min-height:84px}
    .row{display:grid;gap:12px}
    .btn{width:100%;padding:12px 16px;border:0;border-radius:10px;background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
    .btn.outline{background:#fff;color:var(--fg);border:1px solid var(--b)}
    .muted.sm{font-size:12px}
    .hide{display:none}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;display:inline-block;margin-left:8px}
    .section-title{display:flex;align-items:center;justify-content:space-between}
    .section-title small{color:var(--muted)}
    /* Modal */
    .modal-bg{position:fixed;inset:0;background:rgba(15,23,42,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;border-radius:16px;max-width:560px;width:92%;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .modal h3{margin:0 0 8px}
    .center{text-align:center}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    /* Banner nueva versi√≥n */
    .update-banner{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;display:none;z-index:60}
    .update-banner button{margin-left:10px}
    /* Bloqueo (autodestrucci√≥n/ventanas) */
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.8);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:40}
    .overlay .modal{box-shadow:none}
    /* Tarjeta imprimible */
    @media print{
      body{background:#fff}
      .no-print{display:none!important}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Sistema 3-2-1 <span id="badges" class="pill no-print"></span></h1>
    <p class="muted">MVP instalable. Define 3 prioridades (micro-pasos), respeta ventanas y guard√°/compart√≠. La app es un puente: a los 30 d√≠as se desactiva.</p>

    <!-- Config r√°pida -->
    <div class="card row no-print">
      <div class="section-title">
        <strong>Configuraci√≥n breve</strong>
        <small id="tz-info"></small>
      </div>
      <input id="partner" placeholder="Contacto de partner (email o tel√©fono, 1 m√°ximo)" />
      <div class="grid2">
        <button class="btn outline" id="btn-export">Exportar datos</button>
        <button class="btn outline" id="btn-import">Importar datos</button>
      </div>
      <p class="muted sm">Tip: si viaj√°s, pod√©s fijar una zona horaria (ej. <code>America/Argentina/Buenos_Aires</code>).</p>
      <div class="grid2">
        <input id="tz" placeholder="Zona horaria (vac√≠o = autom√°tica)" />
        <button class="btn outline" id="save-tz">Guardar zona</button>
      </div>
    </div>

    <!-- Pantalla Ma√±ana -->
    <section id="sec-man" class="card row">
      <div class="section-title">
        <strong>üåÖ Ma√±ana (3‚Äô)</strong>
        <small>Ventana: libre (recomendado al iniciar el d√≠a)</small>
      </div>

      <div>
        <label>1 cosa estrat√©gica (mueve la aguja)</label>
        <input id="p1" maxlength="60" placeholder="Ej: Bajar borrador del informe (t√≠tulo + esquema)" />
      </div>
      <div>
        <label>1 cosa operativa (necesaria hoy)</label>
        <input id="p2" maxlength="60" placeholder="Ej: Enviar 3 correos clave (asunto listo)" />
      </div>
      <div>
        <label>1 cosa de bienestar</label>
        <input id="p3" maxlength="60" placeholder="Ej: Caminar 10‚Äô al sol" />
      </div>

      <button class="btn outline" id="btn-deal">Simplificar con DEAL</button>

      <div class="grid2">
        <button class="btn outline" id="btn-momentos">Definir momentos</button>
        <button class="btn outline" id="btn-ritual">Definir ritual</button>
      </div>

      <div class="grid2">
        <button class="btn" id="btn-guardar">Guardar</button>
        <button class="btn outline" id="btn-compartir">Compartir con partner</button>
      </div>
      <button class="btn outline" id="btn-tarjeta">Generar tarjeta 3-2-1</button>
      <p class="muted sm">Escrib√≠ micro-pasos. Ej: ‚ÄúAbrir doc y escribir t√≠tulo‚Äù en vez de ‚ÄúHacer informe‚Äù.</p>
    </section>

    <!-- Pantalla Mediod√≠a -->
    <section id="sec-med" class="card row">
      <div class="section-title">
        <strong>‚òÄÔ∏è Mediod√≠a (1‚Äô)</strong>
        <small>Ventana: 12:00‚Äì14:00 (hora local)</small>
      </div>
      <label>¬øVas por tus prioridades?</label>
      <div class="grid2">
        <button class="btn" id="ok-med">S√≠, voy bien</button>
        <button class="btn outline" id="ajustar-med">Necesito ajustar</button>
      </div>
      <button class="btn outline" id="desconc-med">Me desconcentr√© (ROE)</button>
      <button class="btn outline" id="ver-tarjeta">Ver mi tarjeta 3-2-1</button>
      <p class="muted sm">Esta pantalla solo aparece entre 12‚Äì14. Si ya respondiste, volv√©s al foco.</p>
    </section>

    <!-- Pantalla Noche -->
    <section id="sec-noc" class="card row">
      <div class="section-title">
        <strong>üåô Noche (3‚Äô)</strong>
        <small>Ventana: 20:00‚Äì22:00 (hora local)</small>
      </div>

      <div>
        <label><input type="checkbox" id="chk1" /> ¬øCompletaste la estrat√©gica?</label>
      </div>
      <div>
        <label><input type="checkbox" id="chk2" /> ¬øCompletaste la operativa?</label>
      </div>
      <div>
        <label><input type="checkbox" id="chk3" /> ¬øHiciste bienestar?</label>
      </div>

      <textarea id="reflex" placeholder="Mini-revisi√≥n: qu√© postergaste, qu√© sentiste, qu√© har√°s distinto ma√±ana‚Ä¶"></textarea>

      <div class="grid2">
        <button class="btn" id="celebrar">Celebrar y cerrar</button>
        <button class="btn outline" id="tarjeta-dia">Tarjeta imprimible del d√≠a</button>
      </div>
    </section>

    <!-- Modales -->
    <div id="modal-deal" class="modal-bg">
      <div class="modal">
        <h3>Simplificar con DEAL</h3>
        <div class="row">
          <textarea id="dealD" placeholder="D ‚Äì ¬øQu√© quer√©s lograr REALMENTE?"></textarea>
          <textarea id="dealE" placeholder="E ‚Äì ¬øQu√© pod√©s ELIMINAR?"></textarea>
          <textarea id="dealA" placeholder="A ‚Äì ¬øQu√© pod√©s AUTOMATIZAR?"></textarea>
          <textarea id="dealL" placeholder="L ‚Äì ¬øA qui√©n pod√©s LIBERAR esta parte?"></textarea>
        </div>
        <div class="grid2" style="margin-top:10px">
          <button class="btn" id="deal-ok">Aplicar a mis 3 puntos</button>
          <button class="btn outline" data-close="#modal-deal">Cerrar</button>
        </div>
      </div>
    </div>

    <div id="modal-roe" class="modal-bg">
      <div class="modal">
        <h3>ROE ‚Äì Respir√° ¬∑ Observ√° ¬∑ Eleg√≠</h3>
        <p class="muted">Respir√° 10 segundos‚Ä¶</p>
        <div class="row">
          <textarea id="roe1" placeholder="¬øQu√© sent√≠s ahora?"></textarea>
          <textarea id="roe2" placeholder="¬øQu√© pens√°s ahora?"></textarea>
          <textarea id="roe3" placeholder="¬øCu√°l es el micro-paso que pod√©s hacer YA?"></textarea>
        </div>
        <div class="grid2" style="margin-top:10px">
          <button class="btn" id="roe-hacer">Hacer ahora (5‚Äô)</button>
          <button class="btn outline" id="roe-reprog">Reprogramar en micropasos</button>
        </div>
        <button class="btn outline" style="margin-top:10px" data-close="#modal-roe">Cerrar</button>
      </div>
    </div>

    <div id="modal-momentos" class="modal-bg">
      <div class="modal">
        <h3>Definir momentos</h3>
        <input id="mom1" placeholder="Despu√©s de completar ___ celebrar√© ___" />
        <input id="mom2" placeholder="Al terminar el d√≠a, reconocer√© ___" />
        <div class="grid2" style="margin-top:10px">
          <button class="btn" id="mom-ok">Guardar</button>
          <button class="btn outline" data-close="#modal-momentos">Cerrar</button>
        </div>
      </div>
    </div>

    <div id="modal-ritual" class="modal-bg">
      <div class="modal">
        <h3>Definir ritual</h3>
        <select id="ritualSel">
          <option value="">Eleg√≠ una opci√≥n</option>
          <option>Respirar 3 veces antes de empezar</option>
          <option>Escribir: ‚ÄúHoy avanzo con claridad‚Äù</option>
          <option>Escuchar mi canci√≥n de poder</option>
          <option>Tomar 1 minuto de silencio</option>
        </select>
        <textarea id="ritualExtra" placeholder="Opcional: personaliz√° tu ritual"></textarea>
        <div class="grid2" style="margin-top:10px">
          <button class="btn" id="ritual-ok">Guardar</button>
          <button class="btn outline" data-close="#modal-ritual">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal l√≠mite diario -->
    <div id="limit-modal" class="modal-bg">
      <div class="modal center">
        <h3>L√≠mite diario alcanzado</h3>
        <p class="muted">Tu plan permite 7 minutos/d√≠a. Volv√© ma√±ana.</p>
        <button class="btn outline" id="limit-ok">Entendido</button>
      </div>
    </div>

    <!-- Overlays (bloqueos por ventanas/autodestrucci√≥n) -->
    <div id="window-overlay" class="overlay">
      <div class="modal center">
        <h3>No disponible ahora</h3>
        <p class="muted" id="window-msg"></p>
        <button class="btn outline" id="window-ok">Entendido</button>
      </div>
    </div>

    <div id="destroy-overlay" class="overlay">
      <div class="modal center">
        <h3>Fin del puente (30 d√≠as)</h3>
        <p class="muted">La app se desactiva para ayudarte a pasar al sistema f√≠sico. Pod√©s exportar tus datos.</p>
        <div class="grid2">
          <button class="btn outline" id="exp-from-destroy">Exportar</button>
          <button class="btn" id="destroy-ok">Entendido</button>
        </div>
      </div>
    </div>

    <!-- Banner actualizaci√≥n -->
    <div id="update-banner" class="update-banner no-print">
      Nueva versi√≥n disponible.
      <button class="btn outline" id="btn-refresh">Actualizar</button>
    </div>
  </div>

  <script>
    // ==========================
    //  Utilidades de tiempo local
    // ==========================
    const TZ = localStorage.getItem('tz') || Intl.DateTimeFormat().resolvedOptions().timeZone;
    const nowTZ = () => new Date(new Date().toLocaleString('en-US', { timeZone: TZ }));
    const dayKey = () => {
      const d = nowTZ();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    };
    const minutesNowTZ = () => { const d = nowTZ(); return d.getHours()*60 + d.getMinutes(); };
    const isBetweenLocal = (hStart, hEnd) => { const m = minutesNowTZ(); return m >= hStart*60 && m < hEnd*60; };
    document.getElementById('tz-info').textContent = `Zona: ${TZ}`;

    // ==========================
    //  Estado y persistencia
    // ==========================
    const KEY = 's321_state';
    const read = () => { try { return JSON.parse(localStorage.getItem(KEY) || '{}'); } catch { return {}; } };
    const write = (obj) => localStorage.setItem(KEY, JSON.stringify(obj));
    let S = read();
    if (!S.install_ts){ S.install_ts = Date.now(); write(S); }

    // ==========================
    //  L√≠mite 7 min/d√≠a (por d√≠a local)
    // ==========================
    const DAILY_LIMIT_MS = 7*60*1000;
    function readUsage(){ try{ return JSON.parse(localStorage.getItem('usage_by_day')||'{}'); }catch{ return {}; } }
    function writeUsage(o){ localStorage.setItem('usage_by_day', JSON.stringify(o)); }
    let usage = readUsage();
    let sessionStart = null;

    function onVisible(){ sessionStart = nowTZ(); }
    function onHidden(){
      if(!sessionStart) return;
      const spent = nowTZ() - sessionStart;
      const k = dayKey();
      usage[k] = (usage[k]||0) + (spent>0?spent:0);
      writeUsage(usage);
      sessionStart = null;
      S.last_active = Date.now(); write(S);
    }
    document.addEventListener('visibilitychange', ()=> document.visibilityState==='visible'?onVisible():onHidden());
    if(document.visibilityState==='visible') onVisible();
    window.addEventListener('pagehide', onHidden);
    window.addEventListener('beforeunload', onHidden);

    function remainingMsToday(){ return DAILY_LIMIT_MS - (readUsage()[dayKey()]||0); }

    function mostrarLimite(){ // usado por el chequeo peri√≥dico
      const m = document.getElementById('limit-modal');
      m.style.display='flex';
    }
    document.getElementById('limit-ok').onclick=()=>document.getElementById('limit-modal').style.display='none';

    setInterval(()=>{
      if(sessionStart && remainingMsToday()<=0){
        onHidden(); mostrarLimite();
      }
    },1000);

    // ==========================
    //  Ventanas y overlays
    // ==========================
    function showWindowMessage(msg){
      document.getElementById('window-msg').textContent = msg;
      document.getElementById('window-overlay').style.display='flex';
    }
    document.getElementById('window-ok').onclick=()=>document.getElementById('window-overlay').style.display='none';

    function enforceWindows(){
      const med = document.getElementById('sec-med');
      const noc = document.getElementById('sec-noc');
      // Mediod√≠a solo 12-14
      med.classList.toggle('hide', !isBetweenLocal(12,14));
      // Noche solo 20-22
      noc.classList.toggle('hide', !isBetweenLocal(20,22));
    }
    enforceWindows();
    setInterval(enforceWindows, 30_000);

    // ==========================
    //  Autodestrucci√≥n a 30 d√≠as
    // ==========================
    const daysSinceInstall = Math.floor((Date.now() - (S.install_ts||Date.now()))/86400000);
    if(daysSinceInstall>=30){
      const d = document.getElementById('destroy-overlay');
      d.style.display='flex';
      document.getElementById('exp-from-destroy').onclick = ()=>exportar();
      document.getElementById('destroy-ok').onclick = ()=>{ d.style.display='none'; };
    }

    // ==========================
    //  Resiliencia: 2 d√≠as sin uso
    // ==========================
    if(S.last_active){
      const daysIdle = Math.floor((Date.now()-S.last_active)/86400000);
      if(daysIdle>=2){
        // Empujar a ROE directamente
        abrir('#modal-roe');
      }
    }

    // ==========================
    //  UI helpers
    // ==========================
    const $ = sel => document.querySelector(sel);
    function abrir(id){ const n=$(id); if(n) n.style.display='flex'; }
    function cerrar(id){ const n=$(id); if(n) n.style.display='none'; }
    document.querySelectorAll('[data-close]').forEach(b=>b.onclick=()=>cerrar(b.getAttribute('data-close')));

    // ==========================
    //  Carga inicial a inputs
    // ==========================
    function loadInputs(){
      $('#p1').value = S.p1||'';
      $('#p2').value = S.p2||'';
      $('#p3').value = S.p3||'';
      $('#partner').value = S.partner||'';
      $('#mom1').value = S.mom1||'';
      $('#mom2').value = S.mom2||'';
      $('#ritualSel').value = S.ritualSel||'';
      $('#ritualExtra').value = S.ritualExtra||'';
      $('#tz').value = localStorage.getItem('tz')||'';
      // checks noche
      $('#chk1').checked = !!S.chk1;
      $('#chk2').checked = !!S.chk2;
      $('#chk3').checked = !!S.chk3;
      $('#reflex').value = S.reflex||'';
      // badges
      $('#badges').textContent = `D√≠a ${daysSinceInstall+1} ¬∑ Restan ${(Math.max(0,remainingMsToday())/60000).toFixed(1)} min`;
    }
    loadInputs();

    // ==========================
    //  Guardado b√°sico
    // ==========================
    function save(){
      S.p1 = $('#p1').value.trim();
      S.p2 = $('#p2').value.trim();
      S.p3 = $('#p3').value.trim();
      S.partner = $('#partner').value.trim();
      S.mom1 = $('#mom1').value.trim();
      S.mom2 = $('#mom2').value.trim();
      S.ritualSel = $('#ritualSel').value;
      S.ritualExtra = $('#ritualExtra').value.trim();
      S.last_active = Date.now();
      write(S);
      loadInputs();
    }

    // ==========================
    //  Botones principales
    // ==========================
    $('#btn-deal').onclick = ()=>abrir('#modal-deal');
    $('#btn-momentos').onclick = ()=>abrir('#modal-momentos');
    $('#btn-ritual').onclick = ()=>abrir('#modal-ritual');
    $('#btn-guardar').onclick = ()=>{ save(); alert('Guardado ‚úì'); };

    // DEAL aplica notas a campos como recordatorio (no pisa el texto)
    $('#deal-ok').onclick = ()=>{
      const d = [$('#dealD').value,$('#dealE').value,$('#dealA').value,$('#dealL').value].filter(Boolean).join(' ¬∑ ');
      if (d){
        S.deal = d; write(S);
        alert('DEAL aplicado como nota mental. Usalo para simplificar tus 3 puntos.');
      }
      cerrar('#modal-deal');
    };

    // ROE
    $('#desconc-med').onclick = ()=>abrir('#modal-roe');
    $('#roe-hacer').onclick = ()=>{
      const micro = $('#roe3').value.trim();
      if(micro){ alert(`Hacelo ahora 5‚Äô: ${micro}`); }
      cerrar('#modal-roe');
    };
    $('#roe-reprog').onclick = ()=>{
      alert('Reprogramado como micro-pasos. Ajust√° en la ma√±ana.');
      cerrar('#modal-roe');
    };

    // Momentos / Ritual
    $('#mom-ok').onclick = ()=>{ save(); cerrar('#modal-momentos'); };
    $('#ritual-ok').onclick = ()=>{ save(); cerrar('#modal-ritual'); };

    // Mediod√≠a
    $('#ok-med').onclick = ()=>alert('Perfecto. Volv√© al foco.');
    $('#ajustar-med').onclick = ()=>abrir('#modal-deal');
    $('#ver-tarjeta').onclick = ()=>generarTarjeta(false);

    // Noche
    $('#chk1').onchange = e=>{ S.chk1=e.target.checked; write(S); };
    $('#chk2').onchange = e=>{ S.chk2=e.target.checked; write(S); };
    $('#chk3').onchange = e=>{ S.chk3=e.target.checked; write(S); };
    $('#reflex').oninput = e=>{ S.reflex=e.target.value; write(S); };
    $('#celebrar').onclick = ()=>{
      alert('Bien hecho. D√≠a cerrado.');
      // opci√≥n: podr√≠as resetear checks ac√°
    };
    $('#tarjeta-dia').onclick = ()=>generarTarjeta(true);

    // Compartir (m√°x. 2 al d√≠a)
    function shareCount(){ try{ return JSON.parse(localStorage.getItem('share_by_day')||'{}'); }catch{return{}} }
    function incShare(){
      const m=shareCount(),k=dayKey(); m[k]=(m[k]||0)+1; localStorage.setItem('share_by_day',JSON.stringify(m)); return m[k];
    }
    $('#btn-compartir').onclick = async ()=>{
      const m=shareCount(),k=dayKey(); if((m[k]||0)>=2){ return alert('L√≠mite de 2 env√≠os diarios.'); }
      save();
      const text = `Tarjeta 3-2-1
‚Ä¢ Estrat√©gica: ${S.p1||''}
‚Ä¢ Operativa: ${S.p2||''}
‚Ä¢ Bienestar: ${S.p3||''}
Momentos: ${S.mom1||''} | ${S.mom2||''}
Ritual: ${S.ritualSel||''} ${S.ritualExtra||''}`.trim();
      try{
        if(navigator.share){ await navigator.share({title:'3-2-1',text}); incShare(); }
        else{
          await navigator.clipboard.writeText(text);
          incShare(); alert('Copiado al portapapeles. Pegalo en tu chat/correo.');
        }
      }catch(e){ /* cancelado */ }
    };

    // Tarjeta imprimible
    $('#btn-tarjeta').onclick = ()=>generarTarjeta(false);
    function generarTarjeta(conLogro){
      save();
      const d = `
<html><head><meta charset="utf-8"><title>Tarjeta 3-2-1</title>
<style>body{font-family:system-ui,sans-serif;padding:24px;background:#f8fafc;color:#0f172a}
.t{background:#fff;border-radius:16px;padding:24px;box-shadow:0 6px 24px rgba(0,0,0,.08);max-width:560px;margin:auto}
h2{margin-top:0} .item{margin:12px 0} .lbl{color:#64748b;font-size:14px}</style></head>
<body><div class="t">
  <h2>Tarjeta 3-2-1</h2>
  <div class="item"><div class="lbl">Estrat√©gica</div><div><strong>${S.p1||''}</strong></div></div>
  <div class="item"><div class="lbl">Operativa</div><div><strong>${S.p2||''}</strong></div></div>
  <div class="item"><div class="lbl">Bienestar</div><div><strong>${S.p3||''}</strong></div></div>
  <div class="item"><div class="lbl">Momentos</div><div>${S.mom1||''} ¬∑ ${S.mom2||''}</div></div>
  <div class="item"><div class="lbl">Ritual</div><div>${S.ritualSel||''} ${S.ritualExtra||''}</div></div>
  ${conLogro?`<div class="item"><div class="lbl">Revisi√≥n</div><div>${(S.reflex||'').replace(/\n/g,'<br>')}</div></div>`:''}
</div>
<script>window.print()<\/script>
</body></html>`;
      const w = window.open('','_blank'); w.document.write(d); w.document.close();
    }

    // Exportar/Importar
    function exportar(){
      const blob = new Blob([JSON.stringify({S,usage:readUsage()},null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = `s321-backup-${dayKey()}.json`; a.click();
      URL.revokeObjectURL(a.href);
    }
    $('#btn-export').onclick = exportar;
    $('#btn-import').onclick = async ()=>{
      const f = document.createElement('input'); f.type='file'; f.accept='application/json';
      f.onchange = async ()=>{
        const file = f.files[0]; if(!file) return;
        const data = JSON.parse(await file.text());
        if(data.S){ S=data.S; write(S); }
        if(data.usage){ writeUsage(data.usage); usage=data.usage; }
        loadInputs(); alert('Importado ‚úì');
      };
      f.click();
    };

    // Guardar zona horaria
    $('#save-tz').onclick = ()=>{
      const val = $('#tz').value.trim();
      if(val) localStorage.setItem('tz',val); else localStorage.removeItem('tz');
      location.reload();
    };

    // ==========================
    //  Bloqueo por ventanas (UX)
    // ==========================
    function guardWithWindows(handler, windowCheck, msg){
      return function(){
        if(!windowCheck()){ showWindowMessage(msg); return; }
        handler();
      }
    }
    // Aplicar a botones de mediod√≠a y noche:
    $('#ok-med').onclick = guardWithWindows($('#ok-med').onclick, ()=>isBetweenLocal(12,14), 'Mediod√≠a funciona de 12:00 a 14:00 (hora local).');
    $('#ajustar-med').onclick = guardWithWindows($('#ajustar-med').onclick, ()=>isBetweenLocal(12,14), 'Mediod√≠a funciona de 12:00 a 14:00 (hora local).');
    $('#desconc-med').onclick = guardWithWindows($('#desconc-med').onclick, ()=>isBetweenLocal(12,14), 'Mediod√≠a funciona de 12:00 a 14:00 (hora local).');
    $('#ver-tarjeta').onclick = guardWithWindows($('#ver-tarjeta').onclick, ()=>isBetweenLocal(12,14), 'Mediod√≠a funciona de 12:00 a 14:00 (hora local).');

    $('#celebrar').onclick = guardWithWindows($('#celebrar').onclick, ()=>isBetweenLocal(20,22), 'Noche funciona de 20:00 a 22:00 (hora local).');
    $('#tarjeta-dia').onclick = guardWithWindows($('#tarjeta-dia').onclick, ()=>isBetweenLocal(20,22), 'Noche funciona de 20:00 a 22:00 (hora local).');

    // ==========================
    //  SW + banner de actualizaci√≥n
    // ==========================
    if('serviceWorker' in navigator){
      window.addEventListener('load', async ()=>{
        try{
          const reg = await navigator.serviceWorker.register('sw.js?v=7');
          // Banner si hay nuevo SW
          let refreshing=false;
          navigator.serviceWorker.addEventListener('controllerchange', ()=>{
            if (refreshing) return; refreshing=true;
            document.getElementById('update-banner').style.display='block';
          });
          document.getElementById('btn-refresh').onclick=()=>location.reload();
        }catch(e){ console.warn('SW error',e); }
      });
    }
  </script>
</body>
</html>
