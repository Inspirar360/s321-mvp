<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sistema 3-2-1</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.json?v=6" />
    <meta name="theme-color" content="#0f172a" />
    <link rel="icon" type="image/png" href="pwa-icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="pwa-icons/icon-192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="3-2-1" />

    <style>
      :root {
        --bg: #f8fafc;
        --fg: #0f172a;
        --muted: #64748b;
        --card: #ffffff;
        --line: #e2e8f0;
        --ok: #16a34a;
        --warn: #ca8a04;
        --bad: #dc2626;
      }
      * { box-sizing: border-box; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--fg); }
      header { position: sticky; top:0; background: var(--bg); border-bottom:1px solid var(--line); z-index:10; }
      .wrap { max-width: 640px; margin:0 auto; padding:16px; }
      h1 { font-size: 20px; margin: 0; }
      nav { display:flex; gap:8px; padding:12px 16px; }
      .tab { flex:1; border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px 12px; text-align:center; cursor:pointer; font-weight:600; }
      .tab[aria-current="true"] { outline:2px solid var(--fg); }
      .card { background: var(--card); border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0; }
      label { display:block; font-weight:600; margin-bottom:6px; }
      input, textarea, select { width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); background:#fff; }
      textarea { resize: vertical; }
      .muted { color: var(--muted); font-size:14px; }
      .row { display:flex; gap:8px; }
      .row > * { flex:1; }
      button { width:100%; padding:12px 16px; border:0; border-radius:10px; background: var(--fg); color:#fff; font-weight:700; cursor:pointer; }
      button.ghost { background:#fff; color: var(--fg); border:1px solid var(--line); }
      .btn-ok { background: var(--ok); }
      .btn-warn { background: var(--warn); }
      .btn-bad { background: var(--bad); }
      .center { text-align:center; }
      .hidden { display:none; }
      .help { font-size:13px; color: var(--muted); margin-top:6px; }
      .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; border:1px solid var(--line); font-size:12px; }
      .divider { height:1px; background: var(--line); margin:12px 0; }
      .lock { position:fixed; inset:0; background:rgba(255,255,255,.9); backdrop-filter:saturate(0.9) blur(4px); display:none; align-items:center; justify-content:center; padding:24px; z-index:100; }
      .lock .box { max-width:560px; width:100%; background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px; }
      .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.25); z-index:100; padding:16px; }
      .modal .box { background:#fff; border-radius:12px; border:1px solid var(--line); padding:16px; max-width:560px; width:100%; }
      .timer { font-variant-numeric: tabular-nums; font-weight:700; }
      .badge { font-size:12px; color:var(--muted); }
      .only-time { padding:10px 12px; border:1px dashed var(--line); border-radius:10px; background:#fff; }
      .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    </style>
  </head>
  <body>
    <header>
      <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px;">
        <h1>3-2-1 — Minimal</h1>
        <div class="badge" id="timerBadge">Tiempo hoy: 00:00 / 07:00</div>
      </div>
      <nav class="wrap" style="padding-top:0;">
        <div class="tab" data-tab="am" aria-current="true">Mañana</div>
        <div class="tab" data-tab="md">Medio día</div>
        <div class="tab" data-tab="pm">Noche</div>
      </nav>
    </header>

    <main class="wrap">
      <!-- MAÑANA -->
      <section id="view-am">
        <div class="card">
          <div class="muted" style="margin-bottom:8px;">¿Qué 3 cosas harás HOY que realmente importan? Escribí <strong>micro‑pasos</strong> (máx. 10 palabras).</div>
          <label>1 cosa estratégica</label>
          <div class="row">
            <input id="estrategica" placeholder="Ej: Abrir el doc y escribir el título" maxlength="80" />
            <button class="ghost" id="deal1" title="DEAL">DEAL</button>
          </div>
          <label style="margin-top:10px;">1 cosa operativa</label>
          <div class="row">
            <input id="operativa" placeholder="Ej: Enviar mail a Juan con 3 bullets" maxlength="80" />
            <button class="ghost" id="deal2" title="DEAL">DEAL</button>
          </div>
          <label style="margin-top:10px;">1 cosa de bienestar</label>
          <div class="row">
            <input id="bienestar" placeholder="Ej: 10 min caminata después del café" maxlength="80" />
            <button class="ghost" id="deal3" title="DEAL">DEAL</button>
          </div>
          <div class="help">Tip: sustituí “hacer informe” por “abrir doc y escribir el título”.</div>
        </div>

        <div class="grid2">
          <div class="card">
            <label>Momentos (opcional)</label>
            <input id="mom-celebro" placeholder="Después de completar ___, celebraré ___" />
            <input id="mom-cierre" placeholder="Al terminar el día, reconoceré ___" style="margin-top:8px;" />
          </div>
          <div class="card">
            <label>Ritual (1 toque)</label>
            <select id="ritual">
              <option value="">Elegí uno…</option>
              <option>Respirar 3 veces antes de empezar</option>
              <option>Escribir mi intención: “Hoy avanzo con claridad”</option>
              <option>Escuchar mi canción de poder</option>
              <option>Tomar 1 minuto de silencio</option>
            </select>
          </div>
        </div>

        <div class="card">
          <label>Socio de rendición (1 contacto)</label>
          <input id="partner" placeholder="Email o teléfono (mailto:/tel:)" />
          <div class="help">La app limita el envío a <strong>2 interacciones/día</strong> (mañana y noche).</div>
        </div>

        <div class="card">
          <div class="row">
            <button id="saveShare">Guardar y compartir</button>
            <button class="ghost" id="setReminder">Recordatorio diario</button>
          </div>
          <div id="status" class="muted" style="margin-top:8px;"></div>
        </div>
      </section>

      <!-- MEDIO DÍA -->
      <section id="view-md" class="hidden">
        <div class="only-time" id="md-window"></div>
        <div class="card">
          <div class="center" style="margin-bottom:8px; font-weight:600;">¿Vas por tus prioridades?</div>
          <div class="row">
            <button class="btn-ok" id="md-ok">Sí, voy bien</button>
            <button class="btn-warn" id="md-adjust">Necesito ajustar</button>
            <button class="btn-bad" id="md-off">Me desconcentré</button>
          </div>
          <div class="help center" style="margin-top:8px;">Solo disponible 12:00–14:00. Si ya respondiste hoy, vuelve a trabajar.</div>
        </div>
        <div class="card center">
          <button class="ghost" id="openCard">Ver mi tarjeta 3-2-1</button>
        </div>
      </section>

      <!-- NOCHE -->
      <section id="view-pm" class="hidden">
        <div class="only-time" id="pm-window"></div>
        <div class="card">
          <div class="muted" style="margin-bottom:8px;">¿Qué lograste hoy que realmente importó?</div>
          <div>
            <label><input type="checkbox" id="chk-e" /> Estratégica</label>
            <label><input type="checkbox" id="chk-o" /> Operativa</label>
            <label><input type="checkbox" id="chk-b" /> Bienestar</label>
          </div>
          <label style="margin-top:10px;">Lo que más me costó fue… (opcional)</label>
          <input id="pm-coste" placeholder="Breve" />
          <div class="divider"></div>
          <div class="muted">Mini‑revisión</div>
          <textarea id="pm-postergue" rows="2" placeholder="¿Qué postergué hoy?"></textarea>
          <textarea id="pm-senti" rows="2" placeholder="¿Qué sentí justo antes de postergar?"></textarea>
          <textarea id="pm-distinto" rows="2" placeholder="¿Qué haré distinto mañana?"></textarea>
        </div>
        <div class="card">
          <div class="row">
            <button id="pm-close">Celebrar y cerrar</button>
            <button class="ghost" id="pm-share">Compartir logro</button>
          </div>
          <div class="help">Se generan tarjetas imprimibles. Máx. 1 envío nocturno/día.</div>
        </div>
      </section>

      <div class="lock" id="lock">
        <div class="box">
          <h3 id="lockTitle">Bloqueado</h3>
          <p id="lockMsg" class="muted"></p>
          <div class="row"><button id="lockOk" class="ghost">Entendido</button></div>
        </div>
      </div>

      <!-- MODALES -->
      <div class="modal" id="modal-deal">
        <div class="box">
          <h3>DEAL rápido</h3>
          <div class="help">Aterricemos tu tarea en un micro‑paso concreto para hoy.</div>
          <label>D — ¿Qué querés lograr <em>realmente</em>?</label>
          <input id="deal-D" />
          <label style="margin-top:8px;">E — ¿Qué parte podés eliminar?</label>
          <input id="deal-E" />
          <label style="margin-top:8px;">A — ¿Qué podés automatizar?</label>
          <input id="deal-A" />
          <label style="margin-top:8px;">L — ¿Qué podrías liberar/delegar?</label>
          <input id="deal-L" />
          <div class="row" style="margin-top:12px;">
            <button id="deal-apply">Aplicar micro‑paso</button>
            <button class="ghost" id="deal-cancel">Cancelar</button>
          </div>
        </div>
      </div>

      <div class="modal" id="modal-roe">
        <div class="box center">
          <h3>ROE — Respirá · Observá · Elegí</h3>
          <div class="muted" style="margin:6px 0 12px;">Respirá 10 segundos</div>
          <div class="timer" id="roeTimer" style="font-size:28px;">00:10</div>
          <div id="roeQs" class="hidden" style="text-align:left; margin-top:12px;">
            <label>¿Qué sentís ahora?</label>
            <input id="roe-sentir" />
            <label style="margin-top:8px;">¿Qué pensás?</label>
            <input id="roe-pensar" />
            <label style="margin-top:8px;">¿Qué micro‑paso podés hacer ahora?</label>
            <input id="roe-paso" />
            <div class="row" style="margin-top:12px;">
              <button id="roe-do" class="btn-ok">Hacer ahora (5 min)</button>
              <button id="roe-reprog" class="btn-warn">Reprogramar</button>
              <button id="roe-del" class="btn-bad">Eliminar</button>
            </div>
          </div>
          <div style="margin-top:12px;">
            <button class="ghost" id="roe-close">Cerrar</button>
          </div>
        </div>
      </div>

    </main>

    <script>
      // ---------- Utilidades ----------
      const $ = (id) => document.getElementById(id);
      const todayKey = () => new Date().toISOString().slice(0,10);
      const clampWords = (s, max=10) => (s||'').trim().split(/\s+/).slice(0,max).join(' ');
      const within = (h1, h2) => { const d=new Date(), h=d.getHours(); return h>=h1 && h<h2; };
      const openWin = (html) => { const w = window.open('', '_blank'); w.document.write(html); w.document.close(); };

      // ---------- Estado ----------
      const KEY = 's321_state_v1';
      const DEF = () => ({
        installedAt: Date.now(),
        plan: 'basic', // basic|pro|master
        usageByDay: {},
        lastVisTs: Date.now(),
        am: {}, pm: {},
        moments: {}, ritual: '',
        partner: '',
        shares: {}, // { YYYY-MM-DD: {am:true, pm:true} }
        lastActive: Date.now(),
        middayAnswered: {},
        settings: { reminder: null }
      });

      let S = load();
      function load(){
        try{ return Object.assign(DEF(), JSON.parse(localStorage.getItem(KEY)||'{}')); }catch{ return DEF(); }
      }
      function save(){ localStorage.setItem(KEY, JSON.stringify(S)); }

      // ---------- Límite de uso diario ----------
      function limitMinutes(){ return S.plan==='basic'?7 : (S.plan==='pro'?10:7); }
      function usageMsToday(){ const k=todayKey(); return S.usageByDay[k]||0; }
      function updateTimerBadge(){
        const ms = usageMsToday();
        const m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000);
        const mm = String(m).padStart(2,'0'), ss = String(s).padStart(2,'0');
        $('timerBadge').textContent = `Tiempo hoy: ${mm}:${ss} / ${String(limitMinutes()).padStart(2,'0')}:00`;
      }
      function tickVisibility(){
        const now = Date.now();
        if (!document.hidden){
          // nada
        } else {
          // al ocultarse, acumulá
          const delta = now - (S.lastVisTs||now);
          const k = todayKey();
          S.usageByDay[k] = (S.usageByDay[k]||0) + Math.max(0, delta);
          save();
        }
        S.lastVisTs = now; save(); updateTimerBadge(); enforceDailyCap();
      }
      document.addEventListener('visibilitychange', tickVisibility);
      window.addEventListener('beforeunload', tickVisibility);
      setInterval(()=>{ if(!document.hidden){ const now=Date.now(); const delta = now - (S.lastVisTs||now); const k=todayKey(); S.usageByDay[k]=(S.usageByDay[k]||0)+delta; S.lastVisTs=now; save(); updateTimerBadge(); enforceDailyCap(); } }, 1000);

      function enforceDailyCap(){
        const cap = limitMinutes()*60000;
        if (usageMsToday() >= cap){
          lock('Límite diario alcanzado', `Tu plan permite ${limitMinutes()} minutos/día. Volvé mañana.`, true);
        }
      }

      // ---------- Autodestrucción / Resiliencia ----------
      function daysSince(ts){ return Math.floor((Date.now()-ts)/86400000); }
      function checkLifecycle(){
        // Resiliencia: 2 días sin uso
        if (daysSince(S.lastActive) >= 2){
          lock('Volvé hoy', '¿Qué pasó? ¿Qué aprendiste? Elegí un micro‑paso y volvé ahora mismo.', false);
        }
        // Autodestrucción: 30 días (basic) / 14 (master)
        const limitDays = (S.plan==='master'?14:30);
        if (daysSince(S.installedAt) >= limitDays){
          lock('Fin del puente (autodestrucción)', `Ya pasaron ${limitDays} días. Exportá tu tarjeta y migrá a tu sistema físico.`, true);
        }
      }

      function lock(title, msg, hard){
        $('lockTitle').textContent = title; $('lockMsg').textContent = msg; $('lock').style.display = 'flex';
        $('lockOk').onclick = ()=>{ if(hard) return; $('lock').style.display='none'; S.lastActive=Date.now(); save(); };
      }

      // ---------- Navegación ----------
      const tabs = Array.from(document.querySelectorAll('.tab'));
      function show(tab){
        tabs.forEach(t=>t.setAttribute('aria-current', String(t.dataset.tab===tab)));
        ['am','md','pm'].forEach(k=> $('view-'+k).classList.toggle('hidden', k!==tab));
        gateTimeMessages();
      }
      tabs.forEach(t=> t.onclick = ()=> show(t.dataset.tab));

      function gateTimeMessages(){
        $('md-window').textContent = within(12,14) ? 'Ventana abierta: 12:00–14:00' : 'Disponible solo 12:00–14:00';
        $('pm-window').textContent = within(20,22) ? 'Ventana abierta: 20:00–22:00' : 'Disponible solo 20:00–22:00';
      }

      // ---------- Cargar campos ----------
      function loadFields(){
        $('estrategica').value = S.am.estrategica||'';
        $('operativa').value = S.am.operativa||'';
        $('bienestar').value = S.am.bienestar||'';
        $('mom-celebro').value = S.moments?.celebro||'';
        $('mom-cierre').value = S.moments?.cierre||'';
        $('ritual').value = S.ritual||'';
        $('partner').value = S.partner||'';
      }

      // ---------- Guardar + compartir (mañana) ----------
      $('saveShare').onclick = () => {
        if (usageMsToday() >= limitMinutes()*60000) return enforceDailyCap();
        S.am = {
          estrategica: clampWords($('estrategica').value,10),
          operativa: clampWords($('operativa').value,10),
          bienestar: clampWords($('bienestar').value,10)
        };
        S.moments = { celebro: $('mom-celebro').value.trim(), cierre: $('mom-cierre').value.trim() };
        S.ritual = $('ritual').value;
        S.partner = $('partner').value.trim();
        S.lastActive = Date.now();
        save();
        $('status').textContent = 'Guardado ✓';
        setTimeout(()=> $('status').textContent='', 1500);
        makeCard('am', true);
        tryShare('am');
      };

      function makeCard(kind='am', autoOpen=false){
        const d = S;
        const li = (arr)=> arr.filter(Boolean).map((x,i)=>`<li>${i+1}) ${x.replace(/</g,'&lt;')}</li>`).join('');
        let html = '';
        if (kind==='am'){
          html = `
          <html><head><meta charset='utf-8'><title>Tarjeta 3-2-1 — Hoy</title>
          <style>body{font-family:system-ui,sans-serif;padding:24px;background:#f8fafc;color:#0f172a}.t{background:#fff;border-radius:16px;padding:24px;box-shadow:0 6px 24px rgba(0,0,0,.08);max-width:560px;margin:auto}h2{margin-top:0}.lbl{color:#64748b;font-size:14px}.sec{margin:12px 0}</style></head>
          <body><div class='t'>
            <h2>Tarjeta 3-2-1 — Hoy</h2>
            <div class='sec'><div class='lbl'>3 cosas</div><ul>${li([d.am.estrategica,d.am.operativa,d.am.bienestar])}</ul></div>
            <div class='sec'><div class='lbl'>Momentos</div><div>${(d.moments.celebro||'')}</div><div>${(d.moments.cierre||'')}</div></div>
            <div class='sec'><div class='lbl'>Ritual</div><div>${d.ritual||''}</div></div>
          </div></body></html>`;
        } else {
          html = `
          <html><head><meta charset='utf-8'><title>Logro del día</title>
          <style>body{font-family:system-ui,sans-serif;padding:24px;background:#f8fafc;color:#0f172a}.t{background:#fff;border-radius:16px;padding:24px;box-shadow:0 6px 24px rgba(0,0,0,.08);max-width:560px;margin:auto}h2{margin-top:0}.lbl{color:#64748b;font-size:14px}.sec{margin:12px 0}</style></head>
          <body><div class='t'>
            <h2>Logro del día</h2>
            <div class='sec'><div class='lbl'>Completado</div><ul>${li([
              $('chk-e').checked?'Estratégica':'' ,
              $('chk-o').checked?'Operativa':'' ,
              $('chk-b').checked?'Bienestar':''
            ])}</ul></div>
            <div class='sec'><div class='lbl'>Mini-revisión</div>
              <div>${($('pm-postergue').value||'').replace(/\n/g,'<br>')}</div>
              <div>${($('pm-senti').value||'').replace(/\n/g,'<br>')}</div>
              <div>${($('pm-distinto').value||'').replace(/\n/g,'<br>')}</div>
            </div>
          </div></body></html>`;
        }
        if (autoOpen) openWin(html);
        return html;
      }

      function tryShare(slot){
        const k = todayKey();
        const daily = S.shares[k] || (S.shares[k] = {});
        if (daily[slot]) return; // ya se compartió ese slot
        const contact = S.partner;
        if (!contact) return;
        const subject = slot==='am'? 'Tarjeta 3-2-1 — Hoy' : 'Logro 3-2-1 — Noche';
        const body = slot==='am'
          ? `Hoy voy con:%0A- ${S.am.estrategica}%0A- ${S.am.operativa}%0A- ${S.am.bienestar}`
          : `Hoy cerré:%0A- Estrategica: ${$('chk-e').checked}%0A- Operativa: ${$('chk-o').checked}%0A- Bienestar: ${$('chk-b').checked}`;

        const shareVia = async () => {
          const text = decodeURIComponent(body.replace(/%0A/g, '\n'));
          if (navigator.share){
            try{ await navigator.share({ title: subject, text }); daily[slot]=true; save(); }catch{ /* cancel */ }
          } else if (contact.startsWith('mailto:')) {
            window.location.href = `${contact}?subject=${encodeURIComponent(subject)}&body=${body}`; daily[slot]=true; save();
          } else if (contact.startsWith('tel:')) {
            alert('Compartí manualmente por tu app de mensajería.');
          } else {
            // fallback: copiar
            navigator.clipboard.writeText(text);
            $('status').textContent = 'Copiado para compartir'; setTimeout(()=> $('status').textContent='', 1500);
            daily[slot]=true; save();
          }
        };
        shareVia();
      }

      $('openCard').onclick = ()=> openWin(makeCard('am', false));

      // ---------- Mediodía ----------
      const mdKey = () => (S.middayAnswered[todayKey()]||false);
      function setMdAnswered(){ S.middayAnswered[todayKey()] = true; save(); }
      $('md-ok').onclick = ()=>{ if(!within(12,14)) return; setMdAnswered(); alert('Ok. Volvé a lo importante.'); };
      $('md-adjust').onclick = ()=>{ if(!within(12,14)) return; const cual = prompt('¿Qué prioridad ajustar? (E/O/B)'); if(!cual) return; const map={E:'estrategica',O:'operativa',B:'bienestar'}; const k=map[cual.toUpperCase()]; if(!k) return; const v=prompt('Nuevo micro‑paso:'); if(!v) return; S.am[k]=clampWords(v,10); save(); loadFields(); setMdAnswered(); };
      $('md-off').onclick = ()=>{ if(!within(12,14)) return; openROE(); setMdAnswered(); };

      // ---------- Noche ----------
      $('pm-close').onclick = ()=>{
        if (!within(20,22)) return;
        S.pm = {
          e: $('chk-e').checked, o: $('chk-o').checked, b: $('chk-b').checked,
          coste: $('pm-coste').value.trim(),
          postergue: $('pm-postergue').value.trim(),
          senti: $('pm-senti').value.trim(),
          distinto: $('pm-distinto').value.trim()
        };
        S.lastActive = Date.now(); save();
        openWin(makeCard('pm', false));
        alert('Bien. Día cerrado.');
      };
      $('pm-share').onclick = ()=> tryShare('pm');

      // ---------- DEAL ----------
      let dealTarget = null;
      function openDeal(targetInput){ dealTarget = targetInput; $('modal-deal').style.display='flex'; }
      function closeDeal(){ $('modal-deal').style.display='none'; ['deal-D','deal-E','deal-A','deal-L'].forEach(id=> $(id).value=''); }
      $('deal1').onclick = ()=> openDeal($('estrategica'));
      $('deal2').onclick = ()=> openDeal($('operativa'));
      $('deal3').onclick = ()=> openDeal($('bienestar'));
      $('deal-cancel').onclick = closeDeal;
      $('deal-apply').onclick = ()=>{
        const D = $('deal-D').value.trim();
        const E = $('deal-E').value.trim();
        const A = $('deal-A').value.trim();
        const L = $('deal-L').value.trim();
        const micro = clampWords(D || A || L || E || '', 10);
        if (dealTarget && micro){ dealTarget.value = micro; }
        closeDeal();
      };

      // ---------- ROE ----------
      function openROE(){ $('modal-roe').style.display='flex'; startBreath(); }
      function closeROE(){ $('modal-roe').style.display='none'; }
      $('roe-close').onclick = closeROE;
      $('roe-do').onclick = ()=>{ closeROE(); alert('Hacé ese micro‑paso ahora (5 min).'); };
      $('roe-reprog').onclick = ()=>{ closeROE(); alert('Reprogramado. Ajustá tu tarjeta.'); };
      $('roe-del').onclick = ()=>{ closeROE(); alert('Eliminado. Enfocate en lo que importa.'); };

      function startBreath(){
        $('roeQs').classList.add('hidden');
        let t=10; $('roeTimer').textContent = '00:10';
        const it = setInterval(()=>{ t--; $('roeTimer').textContent = `00:${String(t).padStart(2,'0')}`; if(t<=0){ clearInterval(it); $('roeQs').classList.remove('hidden'); } },1000);
      }

      // ---------- Recordatorio diario (limitación web: activo solo si la app está abierta) ----------
      $('setReminder').onclick = async () => {
        const hh = prompt('Hora diaria (00-23, formato 24h):');
        if (hh===null) return;
        const h = Math.max(0, Math.min(23, parseInt(hh,10)||0));
        S.settings.reminder = { hour: h };
        save();
        try{ await Notification.requestPermission(); }catch{}
        scheduleReminder();
        $('status').textContent = `Recordatorio configurado a las ${String(h).padStart(2,'0')}:00 (requiere app abierta)`;
      };

      function scheduleReminder(){
        if (!S.settings.reminder) return;
        const now = new Date();
        const target = new Date(); target.setHours(S.settings.reminder.hour, 0, 0, 0);
        if (target <= now) target.setDate(target.getDate()+1);
        const ms = target-now;
        setTimeout(()=>{
          if (('Notification' in window) && Notification.permission==='granted') new Notification('3-2-1', { body: 'Definí tus 3 prioridades ahora.' });
          // re‑programar siguiente mientras la app esté abierta
          scheduleReminder();
        }, ms);
      }

      // ---------- Init ----------
      function init(){
        show('am');
        loadFields();
        updateTimerBadge();
        gateTimeMessages();
        checkLifecycle();
        scheduleReminder();
      }
      init();

      // ---------- SW ----------
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js').catch(console.error);
        });
      }

    </script>
  </body>
</html>
