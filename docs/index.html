<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema 3-2-1</title>

  <!-- Manifest versionado -->
  <link rel="manifest" href="manifest.json?v=10" />
  <meta name="theme-color" content="#0f172a" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="3-2-1" />

  <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--muted:#64748b;--card:#fff;--b:#e2e8f0;--pri:#0f172a;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:640px;margin:0 auto;padding:16px}
    h1{font-size:28px;margin:12px 0 4px}
    p.muted{color:var(--muted);font-size:14px;margin:0 0 16px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 4px 16px rgba(0,0,0,.06);margin:12px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--b);background:#fff;font-size:16px}
    textarea{resize:vertical;min-height:84px}
    .row{display:grid;gap:12px}
    .btn{width:100%;padding:12px 16px;border:0;border-radius:10px;background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
    .btn.outline{background:#fff;color:var(--fg);border:1px solid var(--b)}
    .hide{display:none}
    .muted.sm{font-size:12px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;display:inline-block;margin-left:8px}
    .section-title{display:flex;align-items:center;justify-content:space-between}
    .modal-bg{position:fixed;inset:0;background:rgba(15,23,42,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;border-radius:16px;max-width:560px;width:92%;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .modal h3{margin:0 0 8px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .center{text-align:center}
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.85);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:40}
    .update-banner{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;display:none;z-index:60}
    .update-banner button{margin-left:10px}
    @media print{.no-print{display:none!important}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Sistema 3-2-1 <span id="badges" class="pill no-print"></span></h1>
    <p class="muted">MVP instalable. Define 3 prioridades (micro-pasos), respeta ventanas y guard√°/compart√≠. La app es un puente: a los 30 d√≠as se desactiva.</p>

    <!-- Config -->
    <div class="card row no-print">
      <div class="section-title">
        <strong>Configuraci√≥n</strong>
        <small id="tz-info"></small>
      </div>
      <input id="partner" placeholder="Contacto partner (email o tel√©fono, 1 m√°x.)" />
      <div class="grid2">
        <button class="btn outline" id="btn-export">Exportar snapshot</button>
        <button class="btn outline" id="btn-import">Importar snapshot</button>
      </div>
      <div class="grid2">
        <button class="btn outline" id="btn-export30">Exportar √∫ltimos 30 d√≠as</button>
        <button class="btn outline" id="btn-export30txt">Exportar 30 d√≠as (TXT)</button>
      </div>
      <p class="muted sm">Zona horaria (vac√≠o = autom√°tica). √ötil si viaj√°s.</p>
      <div class="grid2">
        <input id="tz" placeholder="Ej: America/Argentina/Buenos_Aires" />
        <button class="btn outline" id="save-tz">Guardar zona</button>
      </div>
    </div>

    <!-- Ma√±ana -->
    <section id="sec-man" class="card row">
      <div class="section-title">
        <strong>üåÖ Ma√±ana (3‚Äô)</strong>
        <small>Ventana: libre (recomendado al iniciar el d√≠a)</small>
      </div>

      <div><label>1 cosa estrat√©gica</label><input id="p1" maxlength="60" placeholder="Ej: Borrador informe (t√≠tulo + esquema)" /></div>
      <div><label>1 cosa operativa</label><input id="p2" maxlength="60" placeholder="Ej: Enviar 3 correos (asunto listo)" /></div>
      <div><label>1 cosa de bienestar</label><input id="p3" maxlength="60" placeholder="Ej: Caminar 10‚Äô al sol" /></div>

      <button class="btn outline" id="btn-deal">Simplificar con DEAL</button>

      <div class="grid2">
        <button class="btn outline" id="btn-momentos">Definir momentos</button>
        <button class="btn outline" id="btn-ritual">Definir ritual</button>
      </div>

      <div class="grid2">
        <button class="btn" id="btn-guardar">Guardar</button>
        <button class="btn outline" id="btn-compartir">Compartir con partner</button>
      </div>
      <button class="btn outline" id="btn-tarjeta">Generar tarjeta 3-2-1</button>
      <p class="muted sm">Escrib√≠ micro-pasos. Ej: ‚ÄúAbrir doc y escribir t√≠tulo‚Äù.</p>
    </section>

    <!-- Mediod√≠a -->
    <section id="sec-med" class="card row">
      <div class="section-title">
        <strong>‚òÄÔ∏è Mediod√≠a (1‚Äô)</strong>
        <small>Ventana: 12:00‚Äì14:00 (hora local)</small>
      </div>
      <label>¬øVas por tus prioridades?</label>
      <div class="grid2">
        <button class="btn" id="ok-med">S√≠, voy bien</button>
        <button class="btn outline" id="ajustar-med">Necesito ajustar</button>
      </div>
      <button class="btn outline" id="desconc-med">Me desconcentr√© (ROE)</button>
      <button class="btn outline" id="ver-tarjeta">Ver mi tarjeta 3-2-1</button>
    </section>

    <!-- Noche -->
    <section id="sec-noc" class="card row">
      <div class="section-title">
        <strong>üåô Noche (3‚Äô)</strong>
        <small>Ventana: 20:00‚Äì22:00 (hora local)</small>
      </div>

      <label><input type="checkbox" id="chk1" /> ¬øCompletaste la estrat√©gica?</label>
      <label><input type="checkbox" id="chk2" /> ¬øCompletaste la operativa?</label>
      <label><input type="checkbox" id="chk3" /> ¬øHiciste bienestar?</label>

      <textarea id="reflex" placeholder="Mini-revisi√≥n: qu√© postergaste, qu√© sentiste, qu√© har√°s distinto ma√±ana‚Ä¶"></textarea>

      <div class="grid2">
        <button class="btn" id="celebrar">Celebrar y cerrar</button>
        <button class="btn outline" id="tarjeta-dia">Tarjeta imprimible del d√≠a</button>
      </div>
    </section>

    <!-- Modales -->
    <div id="modal-deal" class="modal-bg">
      <div class="modal">
        <h3>Simplificar con DEAL</h3>
        <div class="row">
          <textarea id="dealD" placeholder="D ‚Äì ¬øQu√© quer√©s lograr REALMENTE?"></textarea>
          <textarea id="dealE" placeholder="E ‚Äì ¬øQu√© pod√©s ELIMINAR?"></textarea>
          <textarea id="dealA" placeholder="A ‚Äì ¬øQu√© pod√©s AUTOMATIZAR?"></textarea>
          <textarea id="dealL" placeholder="L ‚Äì ¬øA qui√©n pod√©s LIBERAR esta parte?"></textarea>
        </div>
        <div class="grid2" style="margin-top:10px">
          <button class="btn" id="deal-ok">Aplicar a mis 3 puntos</button>
          <button class="btn outline" data-close="#modal-deal">Cerrar</button>
        </div>
      </div>
    </div>

    <div id="modal-roe" class="modal-bg">
      <div class="modal">
        <h3>ROE ‚Äì Respir√° ¬∑ Observ√° ¬∑ Eleg√≠</h3>
        <p class="muted">Respir√° 10 segundos‚Ä¶</p>
        <div class="row">
          <textarea id="roe1" placeholder="¬øQu√© sent√≠s ahora?"></textarea>
          <textarea id="roe2" placeholder="¬øQu√© pens√°s ahora?"></textarea>
          <textarea id="roe3" placeholder="¬øCu√°l es el micro-paso que pod√©s hacer YA?"></textarea>
        </div>
        <div class="grid2" style="margin-top:10px">
          <button class="btn" id="roe-hacer">Hacer ahora (5‚Äô)</button>
          <button class="btn outline" id="roe-reprog">Reprogramar en micro-pasos</button>
        </div>
        <button class="btn outline" style="margin-top:10px" data-close="#modal-roe">Cerrar</button>
      </div>
    </div>

    <div id="modal-momentos" class="modal-bg">
      <div class="modal">
        <h3>Definir momentos</h3>
        <input id="mom1" placeholder="Despu√©s de completar ___ celebrar√© ___" />
        <input id="mom2" placeholder="Al terminar el d√≠a, reconocer√© ___" />
        <div class="grid2" style="margin-top:10px">
          <button class="btn" id="mom-ok">Guardar</button>
          <button class="btn outline" data-close="#modal-momentos">Cerrar</button>
        </div>
      </div>
    </div>

    <div id="modal-ritual" class="modal-bg">
      <div class="modal">
        <h3>Definir ritual</h3>
        <select id="ritualSel">
          <option value="">Eleg√≠ una opci√≥n</option>
          <option>Respirar 3 veces antes de empezar</option>
          <option>Escribir: ‚ÄúHoy avanzo con claridad‚Äù</option>
          <option>Escuchar mi canci√≥n de poder</option>
          <option>Tomar 1 minuto de silencio</option>
        </select>
        <textarea id="ritualExtra" placeholder="Opcional: personaliz√° tu ritual"></textarea>
        <div class="grid2" style="margin-top:10px">
          <button class="btn" id="ritual-ok">Guardar</button>
          <button class="btn outline" data-close="#modal-ritual">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal l√≠mite diario -->
    <div id="limit-modal" class="modal-bg">
      <div class="modal center">
        <h3>L√≠mite diario alcanzado</h3>
        <p class="muted">Tu plan permite 7 minutos/d√≠a. Volv√© ma√±ana.</p>
        <button class="btn outline" id="limit-ok">Entendido</button>
      </div>
    </div>

    <!-- Overlays -->
    <div id="window-overlay" class="overlay">
      <div class="modal center">
        <h3>No disponible ahora</h3>
        <p class="muted" id="window-msg"></p>
        <button class="btn outline" id="window-ok">Entendido</button>
      </div>
    </div>

    <div id="destroy-overlay" class="overlay">
      <div class="modal center">
        <h3>Fin del puente (30 d√≠as)</h3>
        <p class="muted">La app se desactiva para ayudarte a pasar al sistema f√≠sico. Export√° tus datos.</p>
        <div class="grid2">
          <button class="btn outline" id="exp-from-destroy">Exportar 30 d√≠as</button>
          <button class="btn" id="destroy-ok">Entendido</button>
        </div>
      </div>
    </div>

    <!-- Banner actualizaci√≥n -->
    <div id="update-banner" class="update-banner no-print">
      Nueva versi√≥n disponible.
      <button class="btn outline" id="btn-refresh">Actualizar</button>
    </div>
  </div>

  <script>
    // ===== Zona horaria (local del usuario o forzada)
    const TZ = localStorage.getItem('tz') || Intl.DateTimeFormat().resolvedOptions().timeZone;
    const nowTZ = () => new Date(new Date().toLocaleString('en-US', { timeZone: TZ }));
    const minutesNowTZ = () => { const d = nowTZ(); return d.getHours()*60 + d.getMinutes(); };
    const dayKey = () => { const d=nowTZ(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
    const isBetweenLocal = (hStart,hEnd)=>{ const m=minutesNowTZ(); return m>=hStart*60 && m<hEnd*60; };
    document.getElementById('tz-info').textContent = `Zona: ${TZ}`;

    // ===== Estado base + diario por d√≠a
    const KEY = 's321_state';
    const KEY_D = 's321_diary';
    const read = ()=>{try{return JSON.parse(localStorage.getItem(KEY)||'{}')}catch{return{}}};
    const write = (o)=>localStorage.setItem(KEY,JSON.stringify(o));
    const readDiary = ()=>{try{return JSON.parse(localStorage.getItem(KEY_D)||'{}')}catch{return{}}};
    const writeDiary = (o)=>localStorage.setItem(KEY_D,JSON.stringify(o));
    let S = read(); if(!S.install_ts){ S.install_ts=Date.now(); write(S); }
    let D = readDiary();

    function upsertToday(partial){
      const k = dayKey();
      D[k] = Object.assign({date:k, ts: Date.now()}, D[k]||{}, partial||{});
      writeDiary(D);
    }

    // ===== L√≠mite 7 min/d√≠a
    const DAILY_LIMIT_MS = 7*60*1000;
    const readUsage=()=>{try{return JSON.parse(localStorage.getItem('usage_by_day')||'{}')}catch{return{}}};
    const writeUsage=(o)=>localStorage.setItem('usage_by_day',JSON.stringify(o));
    let usage = readUsage(); let sessionStart=null;

    function onVisible(){ sessionStart=nowTZ(); }
    function onHidden(){
      if(!sessionStart) return;
      const spent = nowTZ()-sessionStart;
      const k=dayKey(); usage[k]=(usage[k]||0)+(spent>0?spent:0);
      writeUsage(usage); sessionStart=null; S.last_active=Date.now(); write(S);
    }
    document.addEventListener('visibilitychange',()=>document.visibilityState==='visible'?onVisible():onHidden());
    if(document.visibilityState==='visible') onVisible();
    window.addEventListener('pagehide',onHidden); window.addEventListener('beforeunload',onHidden);
    const remainingMsToday=()=>DAILY_LIMIT_MS-(readUsage()[dayKey()]||0);
    const showLimit=()=>{document.getElementById('limit-modal').style.display='flex';};
    document.getElementById('limit-ok').onclick=()=>document.getElementById('limit-modal').style.display='none';
    setInterval(()=>{ if(sessionStart && remainingMsToday()<=0){ onHidden(); showLimit(); } },1000);

    // ===== Ventanas
    function showWindowMessage(msg){ document.getElementById('window-msg').textContent=msg; document.getElementById('window-overlay').style.display='flex'; }
    document.getElementById('window-ok').onclick=()=>document.getElementById('window-overlay').style.display='none';
    function enforceWindows(){
      document.getElementById('sec-med').classList.toggle('hide', !isBetweenLocal(12,14));
      document.getElementById('sec-noc').classList.toggle('hide', !isBetweenLocal(20,22));
    }
    enforceWindows(); setInterval(enforceWindows,30000);

    // ===== Autodestrucci√≥n d√≠a 30
    const daysSinceInstall = Math.floor((Date.now()-(S.install_ts||Date.now()))/86400000);
    if(daysSinceInstall>=30){
      const ov=document.getElementById('destroy-overlay');
      ov.style.display='flex';
      document.getElementById('exp-from-destroy').onclick=()=>export30JSON();
      document.getElementById('destroy-ok').onclick=()=>{ ov.style.display='none'; };
    }

    // ===== Resiliencia (2 d√≠as sin uso)
    if(S.last_active){
      const idle = Math.floor((Date.now()-S.last_active)/86400000);
      if(idle>=2){ abrir('#modal-roe'); }
    }

    // ===== Helpers UI
    const $ = s=>document.querySelector(s);
    const abrir = id => { const n=$(id); if(n) n.style.display='flex'; };
    const cerrar = id => { const n=$(id); if(n) n.style.display='none'; };
    document.querySelectorAll('[data-close]').forEach(b=>b.onclick=()=>cerrar(b.getAttribute('data-close')));

    // ===== Carga inicial
    function loadInputs(){
      $('#p1').value=S.p1||''; $('#p2').value=S.p2||''; $('#p3').value=S.p3||'';
      $('#partner').value=S.partner||''; $('#mom1').value=S.mom1||''; $('#mom2').value=S.mom2||'';
      $('#ritualSel').value=S.ritualSel||''; $('#ritualExtra').value=S.ritualExtra||'';
      $('#tz').value=localStorage.getItem('tz')||'';
      $('#chk1').checked=!!S.chk1; $('#chk2').checked=!!S.chk2; $('#chk3').checked=!!S.chk3;
      $('#reflex').value=S.reflex||'';
      $('#badges').textContent=`D√≠a ${daysSinceInstall+1} ¬∑ Restan ${(Math.max(0,remainingMsToday())/60000).toFixed(1)} min`;
    }
    loadInputs();

    // ===== Guardado
    function save(){
      S.p1=$('#p1').value.trim(); S.p2=$('#p2').value.trim(); S.p3=$('#p3').value.trim();
      S.partner=$('#partner').value.trim();
      S.mom1=$('#mom1').value.trim(); S.mom2=$('#mom2').value.trim();
      S.ritualSel=$('#ritualSel').value; S.ritualExtra=$('#ritualExtra').value.trim();
      S.last_active=Date.now(); write(S);
      upsertToday({p1:S.p1,p2:S.p2,p3:S.p3,mom1:S.mom1,mom2:S.mom2,ritualSel:S.ritualSel,ritualExtra:S.ritualExtra});
      loadInputs();
    }

    // ===== Botones Ma√±ana
    $('#btn-deal').onclick=()=>abrir('#modal-deal');
    $('#deal-ok').onclick=()=>{
      const d=[$('#dealD').value,$('#dealE').value,$('#dealA').value,$('#dealL').value].filter(Boolean).join(' ¬∑ ');
      if(d){ S.deal=d; write(S); alert('DEAL aplicado como nota mental.'); }
      cerrar('#modal-deal');
    };
    $('#btn-momentos').onclick=()=>abrir('#modal-momentos');
    $('#mom-ok').onclick=()=>{ save(); cerrar('#modal-momentos'); };
    $('#btn-ritual').onclick=()=>abrir('#modal-ritual');
    $('#ritual-ok').onclick=()=>{ save(); cerrar('#modal-ritual'); };
    $('#btn-guardar').onclick=()=>{ save(); alert('Guardado ‚úì'); };

    // Compartir (2 por d√≠a)
    function shareCount(){try{return JSON.parse(localStorage.getItem('share_by_day')||'{}')}catch{return{}}}
    function incShare(){const m=shareCount(),k=dayKey(); m[k]=(m[k]||0)+1; localStorage.setItem('share_by_day',JSON.stringify(m)); return m[k];}
    $('#btn-compartir').onclick=async()=>{
      const m=shareCount(),k=dayKey(); if((m[k]||0)>=2) return alert('L√≠mite de 2 env√≠os diarios.');
      save();
      const text=`Tarjeta 3-2-1
‚Ä¢ Estrat√©gica: ${S.p1||''}
‚Ä¢ Operativa: ${S.p2||''}
‚Ä¢ Bienestar: ${S.p3||''}
Momentos: ${S.mom1||''} | ${S.mom2||''}
Ritual: ${S.ritualSel||''} ${S.ritualExtra||''}`.trim();
      try{ if(navigator.share){await navigator.share({title:'3-2-1',text}); incShare();}
      else{ await navigator.clipboard.writeText(text); incShare(); alert('Copiado al portapapeles.'); } }catch(e){}
    };

    // Tarjeta imprimible (sin <script> dentro del string)
    $('#btn-tarjeta').onclick=()=>generarTarjeta(false);
    function generarTarjeta(conLogro){
      save();
      const html = `
<html><head><meta charset="utf-8"><title>Tarjeta 3-2-1</title>
<style>body{font-family:system-ui,sans-serif;padding:24px;background:#f8fafc;color:#0f172a}
.t{background:#fff;border-radius:16px;padding:24px;box-shadow:0 6px 24px rgba(0,0,0,.08);max-width:560px;margin:auto}
h2{margin-top:0}.item{margin:12px 0}.lbl{color:#64748b;font-size:14px}</style></head>
<body><div class="t">
  <h2>Tarjeta 3-2-1</h2>
  <div class="item"><div class="lbl">Estrat√©gica</div><div><strong>${S.p1||''}</strong></div></div>
  <div class="item"><div class="lbl">Operativa</div><div><strong>${S.p2||''}</strong></div></div>
  <div class="item"><div class="lbl">Bienestar</div><div><strong>${S.p3||''}</strong></div></div>
  <div class="item"><div class="lbl">Momentos</div><div>${S.mom1||''} ¬∑ ${S.mom2||''}</div></div>
  <div class="item"><div class="lbl">Ritual</div><div>${S.ritualSel||''} ${S.ritualExtra||''}</div></div>
  ${conLogro?`<div class="item"><div class="lbl">Revisi√≥n</div><div>${(S.reflex||'').replace(/\n/g,'<br>')}</div></div>`:''}
</div></body></html>`;
      const w=window.open('','_blank'); w.document.open(); w.document.write(html); w.document.close();
      w.onload=()=>{ try{w.focus(); w.print();}catch(e){} };
      setTimeout(()=>{ try{w.focus(); w.print();}catch(e){} },400);
    }

    // ===== Mediod√≠a (ventana 12‚Äì14)
    function guardMed(handler){
      return ()=>{ if(!isBetweenLocal(12,14)) return showWindowMessage('Mediod√≠a funciona 12:00‚Äì14:00 (hora local).'); handler(); };
    }
    $('#ok-med').onclick=guardMed(()=>alert('Perfecto. Volv√© al foco.'));
    $('#ajustar-med').onclick=guardMed(()=>abrir('#modal-deal'));
    $('#desconc-med').onclick=guardMed(()=>abrir('#modal-roe'));
    $('#ver-tarjeta').onclick=guardMed(()=>generarTarjeta(false));

    // ROE
    $('#roe-hacer').onclick=()=>{ const micro=$('#roe3').value.trim(); if(micro) alert(`Hacelo ahora 5‚Äô: ${micro}`); cerrar('#modal-roe'); };
    $('#roe-reprog').onclick=()=>{ alert('Reprogramado como micro-pasos. Ajust√° en la ma√±ana.'); cerrar('#modal-roe'); };

    // ===== Noche (ventana 20‚Äì22)
    function guardNoc(handler){
      return ()=>{ if(!isBetweenLocal(20,22)) return showWindowMessage('Noche funciona 20:00‚Äì22:00 (hora local).'); handler(); };
    }
    $('#chk1').onchange=e=>{ S.chk1=e.target.checked; write(S); upsertToday({chk1:S.chk1}); };
    $('#chk2').onchange=e=>{ S.chk2=e.target.checked; write(S); upsertToday({chk2:S.chk2}); };
    $('#chk3').onchange=e=>{ S.chk3=e.target.checked; write(S); upsertToday({chk3:S.chk3}); };
    $('#reflex').oninput=e=>{ S.reflex=e.target.value; write(S); upsertToday({reflex:S.reflex}); };
    $('#celebrar').onclick=guardNoc(()=>{ alert('Bien hecho. D√≠a cerrado.'); upsertToday({closed:true}); });
    $('#tarjeta-dia').onclick=guardNoc(()=>generarTarjeta(true));

    // ===== Exportar/Importar (snapshot) y 30 d√≠as
    function download(name, text, type='application/json'){
      const blob=new Blob([text],{type}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
    }
    function exportar(){
      const payload={S, diary:readDiary(), usage:readUsage(), tz:TZ, exported_at:new Date().toISOString()};
      download(`s321-snapshot-${dayKey()}.json`, JSON.stringify(payload,null,2));
    }
    $('#btn-export').onclick=exportar;

    $('#btn-import').onclick=async()=>{
      const f=document.createElement('input'); f.type='file'; f.accept='application/json';
      f.onchange=async()=>{
        const file=f.files[0]; if(!file) return;
        const data=JSON.parse(await file.text());
        if(data.S){ S=data.S; write(S); }
        if(data.diary){ D=data.diary; writeDiary(D); }
        if(data.usage){ writeUsage(data.usage); usage=data.usage; }
        loadInputs(); alert('Importado ‚úì');
      };
      f.click();
    };

    function last30Keys(){
      const keys=Object.keys(readDiary()).sort(); // yyyy-mm-dd asc
      const today=dayKey();
      return keys.filter(k=> {
        const d=new Date(k+'T00:00:00'); // local naive
        const t=new Date(today+'T00:00:00');
        return (t-d)/86400000 <= 29 && (t-d)>=0; // √∫ltimos 30 d√≠as incluyendo hoy
      });
    }
    function export30JSON(){
      const k=last30Keys(); const out=k.map(key=>Object.assign({date:key}, D[key]||{}));
      const payload={range:`${k[0]||''}..${k[k.length-1]||''}`, days: out.length, data: out};
      download(`s321-30dias-${dayKey()}.json`, JSON.stringify(payload,null,2));
    }
    function export30TXT(){
      const k=last30Keys();
      let txt=`Sistema 3-2-1 ‚Äì √∫ltimos 30 d√≠as\nZona: ${TZ}\nGenerado: ${new Date().toISOString()}\n\n`;
      k.forEach(key=>{
        const x=D[key]||{};
        txt += `# ${key}\n- Estrat√©gica: ${x.p1||''}\n- Operativa: ${x.p2||''}\n- Bienestar: ${x.p3||''}\n- Momentos: ${x.mom1||''} | ${x.mom2||''}\n- Ritual: ${x.ritualSel||''} ${x.ritualExtra||''}\n- Checks: E:${x.chk1?'‚úì':'-'} O:${x.chk2?'‚úì':'-'} B:${x.chk3?'‚úì':'-'}\n- Revisi√≥n: ${(x.reflex||'').replace(/\n/g,' ')}\n\n`;
      });
      download(`s321-30dias-${dayKey()}.txt`, txt, 'text/plain');
    }
    $('#btn-export30').onclick=export30JSON;
    $('#btn-export30txt').onclick=export30TXT;

    // ===== Guardar zona horaria
    $('#save-tz').onclick=()=>{ const v=$('#tz').value.trim(); if(v) localStorage.setItem('tz',v); else localStorage.removeItem('tz'); location.reload(); };

    // ===== SW + banner actualizaci√≥n
    if('serviceWorker' in navigator){
      window.addEventListener('load', async ()=>{
        try{
          const reg = await navigator.serviceWorker.register('sw.js?v=10');
          let refreshing=false;
          navigator.serviceWorker.addEventListener('controllerchange', ()=>{
            if(refreshing) return; refreshing=true;
            document.getElementById('update-banner').style.display='block';
          });
          document.getElementById('btn-refresh').onclick=()=>location.reload();
        }catch(e){ console.warn('SW error',e); }
      });
    }
  </script>
</body>
</html>
